# Структура баз данных

Эта папка содержит SQL схемы для организации баз данных всех проектов.

## Архитектура

### Принцип разделения

- **Общая схема `shared`** - таблица `users` доступна всем проектам
- **Схемы проектов** - каждый проект имеет свою схему с собственными таблицами
- Все таблицы проектов ссылаются на `shared.users` через `FOREIGN KEY`

### Преимущества

✅ Единая база пользователей для всех проектов
✅ Изоляция данных между проектами
✅ Простое добавление новых проектов
✅ Чистая структура без конфликтов имён таблиц

## Порядок развёртывания

### Шаг 1: Создание общей схемы (один раз)

Выполните в Supabase SQL Editor:

```sql
-- Файл: 00_shared_schema.sql
```

Это создаст схему `shared` и таблицу `shared.users`.

### Шаг 2: Создание схемы маркетингового бота

Выполните в Supabase SQL Editor:

```sql
-- Файл: 01_marketing_bot_schema.sql
```

Это создаст:
- Схему `marketing_bot`
- Таблицы: `quiz_results`, `booking_requests`, `messages`

### Шаг 3: Для новых проектов

1. Скопируйте `02_new_project_template.sql`
2. Переименуйте файл (например: `03_ecommerce_bot_schema.sql`)
3. Замените `project_name` на имя вашего проекта
4. Измените таблицы под свои нужды
5. Выполните скрипт в Supabase

## Использование в коде

### Подключение к общей таблице users

```javascript
// Сохранение пользователя (доступно для всех проектов)
const { data, error } = await supabase
  .from('users')
  .upsert({
    id: userId,
    first_name: firstName,
    username: username
  })
  .select();
```

### Подключение к таблицам проекта

```javascript
// Для маркетингового бота
const { data, error } = await supabase
  .from('quiz_results')
  .insert({
    user_id: userId,
    question_1: 'q1_a',
    question_2: 'q1_b',
    question_3: 'q1_c'
  });
```

## Важные замечания

⚠️ **Порядок выполнения скриптов важен!** Сначала `00_shared_schema.sql`, потом схемы проектов.

⚠️ **Не удаляйте таблицу `shared.users`** - она используется всеми проектами.

⚠️ **Row Level Security (RLS)** включён на всех таблицах для безопасности.

## Текущие проекты

| Схема | Описание | Таблицы |
|-------|----------|---------|
| `shared` | Общие данные | `users` |
| `marketing_bot` | Telegram-бот маркетолога | `quiz_results`, `booking_requests`, `messages` |

## Добавление нового проекта

1. Создайте новый SQL файл на основе шаблона
2. Придумайте короткое имя схемы (например: `crm`, `shop`, `analytics`)
3. Определите необходимые таблицы
4. Все таблицы с пользовательскими данными должны иметь:
   - `user_id BIGINT REFERENCES shared.users(id) ON DELETE CASCADE`
5. Выполните скрипт в Supabase
