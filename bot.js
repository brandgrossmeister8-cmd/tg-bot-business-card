import TelegramBot from 'node-telegram-bot-api';
import dotenv from 'dotenv';
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// –ü–æ–ª—É—á–∞–µ–º __dirname –¥–ª—è ES –º–æ–¥—É–ª–µ–π
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config();

const token = process.env.TELEGRAM_BOT_TOKEN;
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_KEY;
const adminChatId = process.env.ADMIN_CHAT_ID;

if (!token) {
  console.error('‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!');
  process.exit(1);
}

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå SUPABASE_URL –∏–ª–∏ SUPABASE_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ .env —Ñ–∞–π–ª–µ!');
  process.exit(1);
}

const bot = new TelegramBot(token, { polling: true });
const supabase = createClient(supabaseUrl, supabaseKey);

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–≤–∏–∑–µ
const quizAnswers = {};

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const greetedUsers = new Set();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–µ—Ä–µ—à–ª–∏ –∫–æ –≤—Ç–æ—Ä–æ–º—É —ç—Ç–∞–ø—É
const startedUsers = new Set();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function formatPhoneNumber(phone) {
  // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ –ø–ª—é—Å–∞
  const cleaned = phone.replace(/[^\d+]/g, '');

  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ +7
  let normalized = cleaned;
  if (normalized.startsWith('8')) {
    normalized = '+7' + normalized.slice(1);
  } else if (normalized.startsWith('7') && !normalized.startsWith('+7')) {
    normalized = '+7' + normalized.slice(1);
  } else if (!normalized.startsWith('+')) {
    normalized = '+7' + normalized;
  }

  // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ +7
  const numbers = normalized.replace(/^\+7/, '').replace(/\D/g, '');

  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä
  if (numbers.length === 0) return '+7 ';
  if (numbers.length <= 3) return `+7 (${numbers}`;
  if (numbers.length <= 6) return `+7 (${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
  if (numbers.length <= 8) return `+7 (${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6)}`;
  return `+7 (${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6, 8)}-${numbers.slice(8, 10)}`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function isValidPhoneNumber(phone) {
  // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
  const cleaned = phone.replace(/\D/g, '');

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 11 —Ü–∏—Ñ—Ä: 7XXXXXXXXXX)
  return cleaned.length === 11 && (cleaned.startsWith('7') || cleaned.startsWith('8'));
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ====================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function saveUser(userId, firstName, username) {
  try {
    const { data, error } = await supabase
      .from('users')
      .upsert({
        id: userId,
        first_name: firstName,
        username: username,
        last_interaction: new Date().toISOString(),
        is_active: true
      }, {
        onConflict: 'id'
      });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      return false;
    }
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', userId);
    return true;
  } catch (err) {
    console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
    return false;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–≤–∏–∑–∞
async function saveQuizResult(userId, answers) {
  try {
    const { data, error } = await supabase
      .from('quiz_results')
      .insert({
        user_id: userId,
        question_1: answers.q1,
        question_2: answers.q2,
        question_3: answers.q3,
        completed_at: new Date().toISOString()
      })
      .select();

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–≤–∏–∑–∞:', error);
      return null;
    }
    console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', data[0].id);
    return data[0].id;
  } catch (err) {
    console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–≤–∏–∑–∞:', err);
    return null;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
async function saveBookingRequest(userId, name, phone, quizResultId = null) {
  try {
    const { data, error } = await supabase
      .from('booking_requests')
      .insert({
        user_id: userId,
        name: name,
        phone: phone,
        quiz_result_id: quizResultId,
        status: '–Ω–æ–≤–∞—è'
      });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      return false;
    }
    console.log('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    return true;
  } catch (err) {
    console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏:', err);
    return false;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
async function saveMessage(userId, messageText, messageType = 'user') {
  try {
    const { data, error } = await supabase
      .from('messages')
      .insert({
        user_id: userId,
        message_text: messageText,
        message_type: messageType,
        is_read: false
      });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
      return false;
    }
    console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î');
    return true;
  } catch (err) {
    console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
    return false;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
async function notifyAdmin(userId, firstName, username, messageText) {
  if (!adminChatId) {
    console.log('‚ö†Ô∏è ADMIN_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    return;
  }

  const notification = `
üì© *–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*

üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* ${firstName}
üÜî *User ID:* \`${userId}\`
üì± *Username:* ${username ? '@' + username : '–Ω–µ —É–∫–∞–∑–∞–Ω'}

üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ:*
${messageText}

_–î–ª—è –æ—Ç–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:_
\`/reply ${userId} –≤–∞—à —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞\`
  `.trim();

  try {
    await bot.sendMessage(adminChatId, notification, { parse_mode: 'Markdown' });
    console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É:', err);
  }
}

// ==================== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –ë–î ====================

// –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
function getMainMenuKeyboard() {
  return {
    keyboard: [
      ['üë§ –û–±–æ –º–Ω–µ', 'üìã –£—Å–ª—É–≥–∏'],
      ['üéØ –¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥', 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã']
    ],
    resize_keyboard: true,
    persistent: true
  };
}

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || '–î—Ä—É–≥';
  const username = msg.from.username || null;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  await saveUser(chatId, firstName, username);

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–æ—à–µ–ª –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
  if (startedUsers.has(chatId)) {
    const startMessage = `
üîô *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

/about - üë§ –û–±–æ –º–Ω–µ
/programs - üìã –£—Å–ª—É–≥–∏
/quiz - üéØ –¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥
/start - üîÑ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    `.trim();

    bot.sendMessage(chatId, startMessage, {
      parse_mode: 'Markdown',
      reply_markup: getMainMenuKeyboard()
    });
    return;
  }

  // –ü–æ–º–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–Ω–Ω–æ–≥–æ
  if (!greetedUsers.has(chatId)) {
    greetedUsers.add(chatId);
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  const welcomeMessage = `
–î–æ–±—Ä—ã–π –¥–µ–Ω—å, ${firstName}! –î–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ –°–¢–ê–†–¢
  `.trim();

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
  const photoPath = path.join(__dirname, 'images', 'photo_5440443823147844586_y.jpg');

  try {
    bot.sendPhoto(chatId, fs.createReadStream(photoPath), {
      caption: welcomeMessage
    }).catch((error) => {
      // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error.message);
      bot.sendMessage(chatId, welcomeMessage);
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–æ—Ç–æ:', error.message);
    bot.sendMessage(chatId, welcomeMessage);
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /about
bot.onText(/\/about/, (msg) => {
  const chatId = msg.chat.id;

  const aboutMessage = `
üë§ *–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ –û—Å–º–∞–µ–≤–∞*
üèÜ –ë—Ä–µ–Ω–¥-–≥—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä

üéØ *–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:*
–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–º—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é

‚≠êÔ∏è *–û–ø—ã—Ç:*
32 –≥–æ–¥–∞ –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ

üíº *–ß–µ–º –∑–∞–Ω–∏–º–∞—é—Å—å:*
–§–æ—Ä–º–∏—Ä—É—é —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤. –ü–æ–º–æ–≥–∞—é –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è–º –ø–µ—Ä–µ–π—Ç–∏ –æ—Ç —Ö–∞–æ—Ç–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ –∫ –ø–æ–Ω—è—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –≥–¥–µ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –∫–∞–∂–¥—ã–π —Ä—É–±–ª—å —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

ü§ñ *–ü–æ–¥—Ö–æ–¥ –∫ —Ä–∞–±–æ—Ç–µ:*
–ü—Ä–∏–º–µ–Ω—è—é –ò–ò –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è –∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π.

üì± –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /programs —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –æ–± —É—Å–ª—É–≥–∞—Ö
  `.trim();

  bot.sendMessage(chatId, aboutMessage, {
    parse_mode: 'Markdown',
    reply_markup: getMainMenuKeyboard()
  });
});

// –ö–æ–º–∞–Ω–¥–∞ /programs
bot.onText(/\/programs/, (msg) => {
  const chatId = msg.chat.id;

  const programsMessage = `
üìã *–£—Å–ª—É–≥–∏*

üéØ *1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è*
–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞: –∞—É–¥–∏—Ç, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Ç–∞–∫—Ç–∏–∫–∞

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è
‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π
‚Ä¢ –ü–æ–Ω—è—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

üë§ *2. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞*
–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–ª—å–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞

*–î–ª—è –∫–æ–≥–æ:* –í–ª–∞–¥–µ–ª—å—Ü—ã –º–∞–ª–æ–≥–æ –∏ –º–∏–∫—Ä–æ –±–∏–∑–Ω–µ—Å–∞, —Å–æ–ª–æ-–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–∏
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞
‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –∏ –∫–∞–Ω–∞–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
‚Ä¢ –£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å –∏ –¥–æ–≤–µ—Ä–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

üöÄ *3. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤*
–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã—Ö–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
‚Ä¢ –ö–æ–Ω—Ü–µ–ø—Ü–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã—Ö–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫
‚Ä¢ –ü–ª–∞–Ω –∑–∞–ø—É—Å–∫–∞ —Å –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–∏—Å–∫–æ–≤

üéì *4. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏–Ω–≥–∏*
–û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Ç–∞–∫—Ç–∏–∫–∞, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ò–ò

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –∫–æ–º–∞–Ω–¥—ã
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ò–ò
‚Ä¢ –ì–æ—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
‚Ä¢ –†–æ—Å—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞

üí° *5. –ê—É–¥–∏—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏*
–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∏–ª–µ–Ω–∏—é –ø–æ–∑–∏—Ü–∏–π

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –û—Ü–µ–Ω–∫—É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–π –±—Ä–µ–Ω–¥–∞ –Ω–∞ —Ä—ã–Ω–∫–µ
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
‚Ä¢ –ü–ª–∞–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

ü§ñ *6. –ê—É–¥–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –ò–ò*
–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ò–ò
‚Ä¢ –î–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
‚Ä¢ –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç

üìû *–î–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:*
–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ, –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏ –∏ –±—é–¥–∂–µ—Ç.

üîô –í–µ—Ä–Ω—É—Ç—å—Å—è: /start
  `.trim();

  bot.sendMessage(chatId, programsMessage, {
    parse_mode: 'Markdown',
    reply_markup: getMainMenuKeyboard()
  });
});

// –ö–æ–º–∞–Ω–¥–∞ /contact - –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
bot.onText(/\/contact/, (msg) => {
  const chatId = msg.chat.id;

  const contactMessage = `
üìû *–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π*

üìß *Email:* margaritaosmaeva@yandex.ru

üåê *VK:* [@osmaeva68](https://vk.com/osmaeva68)

üìÖ *–ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:*
–ü—Ä–æ–π–¥–∏—Ç–µ /quiz, –∏ —è –ø–æ–¥–±–µ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏.

üîô –í–µ—Ä–Ω—É—Ç—å—Å—è: /start
  `.trim();

  bot.sendMessage(chatId, contactMessage, {
    parse_mode: 'Markdown',
    reply_markup: getMainMenuKeyboard()
  });
});

// –ö–æ–º–∞–Ω–¥–∞ /reply - –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
bot.onText(/\/reply (\d+) (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥–º–∏–Ω
  if (adminChatId && chatId.toString() !== adminChatId.toString()) {
    bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.');
    return;
  }

  const targetUserId = match[1];
  const replyText = match[2];

  try {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await bot.sendMessage(targetUserId, `üì¨ *–û—Ç–≤–µ—Ç –æ—Ç –ú–∞—Ä–≥–∞—Ä–∏—Ç—ã:*\n\n${replyText}`, {
      parse_mode: 'Markdown'
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –ë–î
    await saveMessage(targetUserId, replyText, 'admin');

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    bot.sendMessage(chatId, `‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserId}`);
    console.log(`‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserId}`);
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', err);
    bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${err.message}`);
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /quiz - —Ç–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
bot.onText(/\/quiz/, (msg) => {
  const chatId = msg.chat.id;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  quizAnswers[chatId] = { answers: [], step: 0 };

  const introMessage = `
üéØ *–¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥*

–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 3 –≤–æ–ø—Ä–æ—Å–∞, –∏ —è –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.

–ù–∞—á–Ω–µ–º? üëá
  `.trim();

  bot.sendMessage(chatId, introMessage, { parse_mode: 'Markdown' }).then(() => {
    sendQuizQuestion(chatId, 0);
  });
});

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∫–≤–∏–∑–∞
function sendQuizQuestion(chatId, questionIndex) {
  const questions = [
    {
      text: '1Ô∏è‚É£ –ß—Ç–æ —Å–µ–π—á–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?',
      options: [
        { text: 'A. –¢—Ä–∞—Ñ–∏–∫ –ø–∞–¥–∞–µ—Ç', callback_data: 'q1_a' },
        { text: 'B. –ù–∏–∑–∫–∏–π —Ç—Ä–∞—Ñ–∏–∫', callback_data: 'q1_b' },
        { text: 'C. –í—Å—ë —Å—Ä–∞–∑—É', callback_data: 'q1_c' }
      ]
    },
    {
      text: '2Ô∏è‚É£ –ß—Ç–æ —Å–µ–π—á–∞—Å –≤—ã –¥–µ–ª–∞–µ—Ç–µ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –±—Ä–µ–Ω–¥–∞?',
      options: [
        { text: 'A. –¢–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞', callback_data: 'q2_a' },
        { text: 'B. –ù–∏—á–µ–≥–æ', callback_data: 'q2_b' },
        { text: 'C. –ú–Ω–æ–≥–æ –≤—Å–µ–≥–æ', callback_data: 'q2_c' }
      ]
    },
    {
      text: '3Ô∏è‚É£ –°–∫–æ–ª—å–∫–æ –ª–µ—Ç –±–∏–∑–Ω–µ—Å—É?',
      options: [
        { text: 'A. –î–æ 2 –ª–µ—Ç', callback_data: 'q3_a' },
        { text: 'B. –î–æ 5 –ª–µ—Ç', callback_data: 'q3_b' },
        { text: 'C. –ë–æ–ª–µ–µ 6 –ª–µ—Ç', callback_data: 'q3_c' }
      ]
    }
  ];

  if (questionIndex < questions.length) {
    const question = questions[questionIndex];
    const keyboard = {
      inline_keyboard: question.options.map(opt => [{ text: opt.text, callback_data: opt.callback_data }])
    };

    bot.sendMessage(chatId, question.text, {
      reply_markup: keyboard,
      parse_mode: 'Markdown'
    });
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–≤–∏–∑
bot.on('callback_query', (callbackQuery) => {
  const chatId = callbackQuery.message.chat.id;
  const data = callbackQuery.data;
  const messageId = callbackQuery.message.message_id;

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É"
  if (data === 'book_diagnostic') {
    bot.answerCallbackQuery(callbackQuery.id);

    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    bot.editMessageReplyMarkup({ inline_keyboard: [] }, {
      chat_id: chatId,
      message_id: messageId
    });

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è
    bot.sendMessage(chatId, 'üë§ *–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?*\n\n–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', { parse_mode: 'Markdown' });

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º username
    quizAnswers[chatId] = {
      ...quizAnswers[chatId],
      stage: 'waiting_name',
      username: callbackQuery.from.username || ''
    };
    return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é"
  if (data === 'back_to_menu') {
    bot.answerCallbackQuery(callbackQuery.id);

    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    bot.editMessageReplyMarkup({ inline_keyboard: [] }, {
      chat_id: chatId,
      message_id: messageId
    });

    // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    delete quizAnswers[chatId];

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    const welcomeMessage = `
üîô *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

/about - üë§ –û–±–æ –º–Ω–µ
/programs - üìã –£—Å–ª—É–≥–∏
/quiz - üéØ –¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥
/start - üîÑ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    `.trim();

    bot.sendMessage(chatId, welcomeMessage, {
      parse_mode: 'Markdown',
      reply_markup: getMainMenuKeyboard()
    });
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–≤–∏–∑
  if (data.startsWith('q')) {
    if (!quizAnswers[chatId]) {
      bot.answerCallbackQuery(callbackQuery.id, { text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /quiz' });
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    quizAnswers[chatId].answers.push(data);
    quizAnswers[chatId].step++;

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
    bot.answerCallbackQuery(callbackQuery.id, { text: '‚úÖ –û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç' });

    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    bot.editMessageReplyMarkup({ inline_keyboard: [] }, {
      chat_id: chatId,
      message_id: messageId
    });

    const currentStep = quizAnswers[chatId].step;

    if (currentStep < 3) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
      sendQuizQuestion(chatId, currentStep);
    } else {
      // –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      showQuizResult(chatId);
    }
  }
});

// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–≤–∏–∑–∞
async function showQuizResult(chatId) {
  // –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ç–µ–∫—Å—Ç—ã
  const answerTexts = {
    'q1_a': '–¢—Ä–∞—Ñ–∏–∫ –ø–∞–¥–∞–µ—Ç',
    'q1_b': '–ù–∏–∑–∫–∏–π —Ç—Ä–∞—Ñ–∏–∫',
    'q1_c': '–í—Å—ë —Å—Ä–∞–∑—É',
    'q2_a': '–¢–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞',
    'q2_b': '–ù–∏—á–µ–≥–æ',
    'q2_c': '–ú–Ω–æ–≥–æ –≤—Å–µ–≥–æ',
    'q3_a': '–î–æ 2 –ª–µ—Ç',
    'q3_b': '–î–æ 5 –ª–µ—Ç',
    'q3_c': '–ë–æ–ª–µ–µ 6 –ª–µ—Ç'
  };

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–¥–æ–≤ –≤ –æ–±—ä–µ–∫—Ç —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
  const answerCodes = quizAnswers[chatId].answers; // ['q1_a', 'q2_b', 'q3_c']
  const answers = {
    q1: answerTexts[answerCodes[0]] || answerCodes[0],
    q2: answerTexts[answerCodes[1]] || answerCodes[1],
    q3: answerTexts[answerCodes[2]] || answerCodes[2]
  };

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  const quizResultId = await saveQuizResult(chatId, answers);

  // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–≤–∏–∑–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–≤—è–∑–∏ —Å –∑–∞—è–≤–∫–æ–π
  if (quizResultId) {
    quizAnswers[chatId].quizResultId = quizResultId;
  }

  const resultMessage = `
‚úÖ *–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!*

–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–æ–≤–µ—Å—Ç–∏ *–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞* –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.

üîç *–ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:*
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ —Ä–æ—Å—Ç–∞
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –ü–æ–¥–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã

üíº *–†–µ–∑—É–ª—å—Ç–∞—Ç:*
–í—ã –ø–æ–ª—É—á–∏—Ç–µ —á–µ—Ç–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ, –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏–Ω–µ—Å—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∫–∞–∫ –≤—ã—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥.
  `.trim();

  const keyboard = {
    inline_keyboard: [
      [
        { text: 'üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É', callback_data: 'book_diagnostic' }
      ],
      [
        { text: 'üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data: 'back_to_menu' }
      ]
    ]
  };

  bot.sendMessage(chatId, resultMessage, {
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
  quizAnswers[chatId] = { ...quizAnswers[chatId], stage: 'result' };
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä—ã)
  if (!text) {
    return;
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞ –ª—é–±–æ–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
  if (!greetedUsers.has(chatId) && !text.startsWith('/')) {
    greetedUsers.add(chatId);
    const firstName = msg.from.first_name || '–î—Ä—É–≥';
    const username = msg.from.username || null;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await saveUser(chatId, firstName, username);

    const welcomeMessage = `
–î–æ–±—Ä—ã–π –¥–µ–Ω—å, ${firstName}! –î–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ –°–¢–ê–†–¢
    `.trim();

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
    const photoPath = path.join(__dirname, 'images', 'photo_5440443823147844586_y.jpg');

    try {
      bot.sendPhoto(chatId, fs.createReadStream(photoPath), {
        caption: welcomeMessage
      }).catch((error) => {
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error.message);
        bot.sendMessage(chatId, welcomeMessage);
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–æ—Ç–æ:', error.message);
      bot.sendMessage(chatId, welcomeMessage);
    }
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–≤–∏–∑–∞ –∏–ª–∏ –∑–∞–ø–∏—Å–∏
  const isInQuizProcess = quizAnswers[chatId] && (
    (quizAnswers[chatId].step !== undefined && quizAnswers[chatId].step < 3) ||
    quizAnswers[chatId].stage === 'waiting_name' ||
    quizAnswers[chatId].stage === 'waiting_phone' ||
    quizAnswers[chatId].stage === 'result'
  );

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–≤–∏–∑–∞/–∑–∞–ø–∏—Å–∏ –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
  if (isInQuizProcess && text.startsWith('/') && text !== '/start') {
    const warningMessage = `
‚ùå *–í–Ω–∏–º–∞–Ω–∏–µ!*

–í—ã –Ω–∞—á–∞–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã.

üéØ –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é.
    `.trim();

    bot.sendMessage(chatId, warningMessage, {
      parse_mode: 'Markdown'
    });
    return;
  }

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ bot.onText
  if (text.startsWith('/')) {
    return;
  }

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–≤–∏–∑–∞/–∑–∞–ø–∏—Å–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
  if (!isInQuizProcess) {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–Ω, –Ω–æ –µ—â–µ –Ω–µ –ø–µ—Ä–µ—à–µ–ª –∫–æ –≤—Ç–æ—Ä–æ–º—É —ç—Ç–∞–ø—É
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –¢–û–õ–¨–ö–û –Ω–∞ —Å–ª–æ–≤–æ "–°–¢–ê–†–¢"
    if (greetedUsers.has(chatId) && !startedUsers.has(chatId) && text.toUpperCase() === '–°–¢–ê–†–¢') {
      startedUsers.add(chatId);

      const firstName = msg.from.first_name || '–î—Ä—É–≥';
      const startMessage = `
üëã *–ü—Ä–∏–≤–µ—Ç, ${firstName}!*

–Ø –±–æ—Ç-–≤–∏–∑–∏—Ç–∫–∞ *–ú–∞—Ä–≥–∞—Ä–∏—Ç—ã –û—Å–º–∞–µ–≤–æ–π* ‚Äî –ë—Ä–µ–Ω–¥-–≥—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä–∞ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–º—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é.

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

/about - üë§ –û–±–æ –º–Ω–µ
/programs - üìã –£—Å–ª—É–≥–∏
/quiz - üéØ –¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥
/contact - üìû –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è
/start - üîÑ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª!
      `.trim();

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
      const photoPath = path.join(__dirname, 'images', 'foto5.png');

      try {
        bot.sendPhoto(chatId, fs.createReadStream(photoPath), {
          caption: startMessage,
          parse_mode: 'Markdown',
          reply_markup: getMainMenuKeyboard()
        }).catch((error) => {
          // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error.message);
          bot.sendMessage(chatId, startMessage, {
            parse_mode: 'Markdown',
            reply_markup: getMainMenuKeyboard()
          });
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–æ—Ç–æ:', error.message);
        bot.sendMessage(chatId, startMessage, {
          parse_mode: 'Markdown',
          reply_markup: getMainMenuKeyboard()
        });
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ—à–µ–¥—à–∏—Ö –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø)
    if (!startedUsers.has(chatId)) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –ø—Ä–æ—à–µ–ª –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
      return;
    }

    if (text === 'üë§ –û–±–æ –º–Ω–µ') {
      const aboutMessage = `
üë§ *–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ –û—Å–º–∞–µ–≤–∞*
üèÜ –ë—Ä–µ–Ω–¥-–≥—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä

üéØ *–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:*
–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–º—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é

‚≠êÔ∏è *–û–ø—ã—Ç:*
32 –≥–æ–¥–∞ –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ

üíº *–ß–µ–º –∑–∞–Ω–∏–º–∞—é—Å—å:*
–§–æ—Ä–º–∏—Ä—É—é —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤. –ü–æ–º–æ–≥–∞—é –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è–º –ø–µ—Ä–µ–π—Ç–∏ –æ—Ç —Ö–∞–æ—Ç–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ –∫ –ø–æ–Ω—è—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –≥–¥–µ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –∫–∞–∂–¥—ã–π —Ä—É–±–ª—å —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

ü§ñ *–ü–æ–¥—Ö–æ–¥ –∫ —Ä–∞–±–æ—Ç–µ:*
–ü—Ä–∏–º–µ–Ω—è—é –ò–ò –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è –∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π.

üì± –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /programs —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –æ–± —É—Å–ª—É–≥–∞—Ö
      `.trim();

      bot.sendMessage(chatId, aboutMessage, {
        parse_mode: 'Markdown',
        reply_markup: getMainMenuKeyboard()
      });
      return;
    }

    if (text === 'üìã –£—Å–ª—É–≥–∏') {
      const programsMessage = `
üìã *–£—Å–ª—É–≥–∏*

üéØ *1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è*
–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞: –∞—É–¥–∏—Ç, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Ç–∞–∫—Ç–∏–∫–∞

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è
‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π
‚Ä¢ –ü–æ–Ω—è—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

üë§ *2. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞*
–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–ª—å–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞

*–î–ª—è –∫–æ–≥–æ:* –í–ª–∞–¥–µ–ª—å—Ü—ã –º–∞–ª–æ–≥–æ –∏ –º–∏–∫—Ä–æ –±–∏–∑–Ω–µ—Å–∞, —Å–æ–ª–æ-–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–∏
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞
‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –∏ –∫–∞–Ω–∞–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
‚Ä¢ –£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å –∏ –¥–æ–≤–µ—Ä–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

üöÄ *3. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤*
–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã—Ö–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
‚Ä¢ –ö–æ–Ω—Ü–µ–ø—Ü–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã—Ö–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫
‚Ä¢ –ü–ª–∞–Ω –∑–∞–ø—É—Å–∫–∞ —Å –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–∏—Å–∫–æ–≤

üéì *4. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏–Ω–≥–∏*
–û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Ç–∞–∫—Ç–∏–∫–∞, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ò–ò

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –∫–æ–º–∞–Ω–¥—ã
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ò–ò
‚Ä¢ –ì–æ—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
‚Ä¢ –†–æ—Å—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞

üí° *5. –ê—É–¥–∏—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏*
–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∏–ª–µ–Ω–∏—é –ø–æ–∑–∏—Ü–∏–π

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –û—Ü–µ–Ω–∫—É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–π –±—Ä–µ–Ω–¥–∞ –Ω–∞ —Ä—ã–Ω–∫–µ
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
‚Ä¢ –ü–ª–∞–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

ü§ñ *6. –ê—É–¥–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –ò–ò*
–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞

*–î–ª—è –∫–æ–≥–æ:* –ú–∞–ª—ã–π –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å
*–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ò–ò
‚Ä¢ –î–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
‚Ä¢ –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç

üìû *–î–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:*
–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ, –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏ –∏ –±—é–¥–∂–µ—Ç.

üîô –í–µ—Ä–Ω—É—Ç—å—Å—è: /start
      `.trim();

      bot.sendMessage(chatId, programsMessage, {
        parse_mode: 'Markdown',
        reply_markup: getMainMenuKeyboard()
      });
      return;
    }

    if (text === 'üéØ –¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥') {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      quizAnswers[chatId] = { answers: [], step: 0 };

      const introMessage = `
üéØ *–¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥*

–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 3 –≤–æ–ø—Ä–æ—Å–∞, –∏ —è –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.

–ù–∞—á–Ω–µ–º? üëá
      `.trim();

      bot.sendMessage(chatId, introMessage, { parse_mode: 'Markdown' }).then(() => {
        sendQuizQuestion(chatId, 0);
      });
      return;
    }

    if (text === 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã') {
      const contactMessage = `
üìû *–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π*

üìß *Email:* margaritaosmaeva@yandex.ru

üåê *VK:* [@osmaeva68](https://vk.com/osmaeva68)

üìÖ *–ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:*
–ü—Ä–æ–π–¥–∏—Ç–µ /quiz, –∏ —è –ø–æ–¥–±–µ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏.

üîô –í–µ—Ä–Ω—É—Ç—å—Å—è: /start
      `.trim();

      bot.sendMessage(chatId, contactMessage, {
        parse_mode: 'Markdown',
        reply_markup: getMainMenuKeyboard()
      });
      return;
    }
  } else {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–≤–∏–∑–∞/–∑–∞–ø–∏—Å–∏, –Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
    const menuButtons = ['üë§ –û–±–æ –º–Ω–µ', 'üìã –£—Å–ª—É–≥–∏', 'üéØ –¢–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥', 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã'];

    if (menuButtons.includes(text) || text.toUpperCase() === '–°–¢–ê–†–¢') {
      const warningMessage = `
‚ùå *–í–Ω–∏–º–∞–Ω–∏–µ!*

–í—ã –Ω–∞—á–∞–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã.

üéØ –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é.
      `.trim();

      bot.sendMessage(chatId, warningMessage, {
        parse_mode: 'Markdown'
      });
      return;
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–ø–∏—Å–∏
  if (quizAnswers[chatId]) {
    const userState = quizAnswers[chatId];

    // –û–∂–∏–¥–∞–µ–º –∏–º—è
    if (userState.stage === 'waiting_name') {
      quizAnswers[chatId].name = text;
      quizAnswers[chatId].stage = 'waiting_phone';

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const keyboard = {
        keyboard: [
          [{ text: 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', request_contact: true }]
        ],
        resize_keyboard: true,
        one_time_keyboard: true
      };

      bot.sendMessage(chatId,
        'üìû *–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞*\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n‚Ä¢ +7 (XXX) XXX-XX-XX\n‚Ä¢ 8XXXXXXXXXX\n‚Ä¢ 7XXXXXXXXXX',
        { parse_mode: 'Markdown', reply_markup: keyboard }
      );
      return;
    }

    // –û–∂–∏–¥–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ç–µ–∫—Å—Ç–æ–º)
    if (userState.stage === 'waiting_phone') {
      // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      if (!isValidPhoneNumber(text)) {
        bot.sendMessage(chatId,
          '‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞*\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ: +7 (XXX) XXX-XX-XX\n–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"',
          { parse_mode: 'Markdown' }
        );
        return;
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      quizAnswers[chatId].phone = formatPhoneNumber(text);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      sendBookingConfirmation(chatId);
      return;
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—á–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–≤–∏–∑–∞)
  if (!isInQuizProcess) {
    const lowerText = text.toLowerCase();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    await saveMessage(chatId, text, 'user');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∫–æ–º–∞–Ω–¥–∞ –∏ –Ω–µ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é)
    if (!text.startsWith('/') && !['üë§ –æ–±–æ –º–Ω–µ', 'üìã —É—Å–ª—É–≥–∏', 'üéØ —Ç–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —É—Å–ª—É–≥', 'üìû –∫–æ–Ω—Ç–∞–∫—Ç—ã'].includes(lowerText)) {
      const firstName = msg.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      const username = msg.from.username || null;
      await notifyAdmin(chatId, firstName, username, text);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ —Ü–µ–Ω–µ/—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    if (lowerText.includes('—Ü–µ–Ω–∞') || lowerText.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') ||
        lowerText.includes('—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç') || lowerText.includes('–ø—Ä–∞–π—Å')) {
      const priceMessage = `
üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥*

–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –∑–∞–¥–∞—á. –Ø —Ä–∞–±–æ—Ç–∞—é —Å –º–∞–ª—ã–º, –º–∏–∫—Ä–æ –∏ —Å—Ä–µ–¥–Ω–∏–º –±–∏–∑–Ω–µ—Å–æ–º, –∏ —Ñ–æ—Ä–º–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ.

üéØ *–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å:*
1. –ü—Ä–æ–π–¥–∏—Ç–µ /quiz ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
2. –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
3. –Ø –ø—Ä–µ–¥–ª–æ–∂—É –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –≤–∞—à–µ–≥–æ –±—é–¥–∂–µ—Ç–∞

üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —É—Å–ª—É–≥–∏: /programs
      `.trim();

      bot.sendMessage(chatId, priceMessage, {
        parse_mode: 'Markdown',
        reply_markup: getMainMenuKeyboard()
      });
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
    if (lowerText.match(/^(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–¥–æ–±—Ä—ã–π –¥–µ–Ω—å|–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä|–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ|hi|hello|hey)$/)) {
      const greetingMessage = `
üëã –ü—Ä–∏–≤–µ—Ç!

–†–∞–¥–∞ –≤–∏–¥–µ—Ç—å –≤–∞—Å! –Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ú–∞—Ä–≥–∞—Ä–∏—Ç—ã –û—Å–º–∞–µ–≤–æ–π.

üéØ *–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?*
‚Ä¢ –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ–±–æ –º–Ω–µ ‚Äî /about
‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —É—Å–ª—É–≥–∏ ‚Äî /programs
‚Ä¢ –ü–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É ‚Äî /quiz
‚Ä¢ –°–≤—è–∑–∞—Ç—å—Å—è ‚Äî /contact

–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª!
      `.trim();

      bot.sendMessage(chatId, greetingMessage, {
        parse_mode: 'Markdown',
        reply_markup: getMainMenuKeyboard()
      });
      return;
    }

    // Fallback –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    const fallbackMessage = `
ü§î –ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å.

*–í–æ—Ç —á—Ç–æ —è –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å:*

üéØ *–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç* ‚Äî /quiz
–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Å—Ç –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏.

üìã *–£—Å–ª—É–≥–∏* ‚Äî /programs
–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏.

üìû *–ö–æ–Ω—Ç–∞–∫—Ç—ã* ‚Äî /contact
–°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π –Ω–∞–ø—Ä—è–º—É—é.

–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ üëá
    `.trim();

    bot.sendMessage(chatId, fallbackMessage, {
      parse_mode: 'Markdown',
      reply_markup: getMainMenuKeyboard()
    });
    return;
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
bot.on('contact', (msg) => {
  const chatId = msg.chat.id;
  const contact = msg.contact;

  if (quizAnswers[chatId] && quizAnswers[chatId].stage === 'waiting_phone') {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è
    bot.sendMessage(chatId, '‚úÖ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—É—á–µ–Ω!', {
      reply_markup: { remove_keyboard: true }
    }).then(() => {
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
      quizAnswers[chatId].phone = formatPhoneNumber(contact.phone_number);
      sendBookingConfirmation(chatId);
    });
  }
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
async function sendBookingConfirmation(chatId) {
  const userData = quizAnswers[chatId];

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—è–≤–∫—É –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  const quizResultId = userData.quizResultId || null;
  await saveBookingRequest(chatId, userData.name, userData.phone, quizResultId);

  const confirmationMessage = `
‚úÖ *–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!*

üìù *–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:*
‚Ä¢ –ò–º—è: ${userData.name}
‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: ${userData.phone}

–ë–ª–∞–≥–æ–¥–∞—Ä—é! –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —è —Å–≤—è–∂—É—Å—å —Å –≤–∞–º–∏.

üîô –í–µ—Ä–Ω—É—Ç—å—Å—è: /start
  `.trim();

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º –º–µ–Ω—é
  bot.sendMessage(chatId, confirmationMessage, {
    parse_mode: 'Markdown',
    reply_markup: getMainMenuKeyboard()
  });

  // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  console.log('üìã –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:');
  console.log(`–ò–º—è: ${userData.name}`);
  console.log(`–¢–µ–ª–µ—Ñ–æ–Ω: ${userData.phone}`);
  console.log(`Telegram: @${userData.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}, ID: ${chatId}`);

  // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  delete quizAnswers[chatId];
}

console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
